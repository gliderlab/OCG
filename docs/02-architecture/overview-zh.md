# 系统概览

OCG-Go (OCG) 的整体架构。

---

## 架构图

```
┌─────────────────────────────────────────────────────────────┐
│                     OCG Gateway (55003)                      │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────────┐ │
│  │  Web UI  │  │ REST API │  │ WebSocket│  │   Channels   │ │
│  └──────────┘  └──────────┘  └──────────┘  └──────────────┘ │
└─────────────────────────┬───────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│                   OCG Agent (Unix Socket)                    │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │    Pulse    │  │  Context    │  │  Tools Registry     │  │
│  │  Heartbeat  │  │  Manager    │  │  (17+ 工具)         │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
│  ┌─────────────┐  ┌─────────────┐                           │
│  │    Tasks    │  │   Memory    │                           │
│  │  Scheduler  │  │  (HNSW/FAISS)│                          │
│  └─────────────┘  └─────────────┘                           │
└─────────────────────────┬───────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│              OCG Embedding (50000-60000)                     │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │            llama.cpp Server                             │ │
│  │  - Embedding 生成                                       │ │
│  │  - 向量相似性搜索                                       │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘

支持的通道:
┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐
│ Telegram  │ │  Discord  │ │   Slack   │ │ WhatsApp  │
├───────────┤ ├───────────┤ ├───────────┤ ├───────────┤
│  Signal   │ │   IRC     │ │ GoogleChat│ │  MS Teams │
├───────────┤ ├───────────┤ ├───────────┤ ├───────────┤
│ Mattermost│ │   LINE    │ │  Matrix   │ │   Feishu  │
└───────────┘ └───────────┘ └───────────┘ └───────────┘
```

---

## 核心组件

### 1. Gateway
**端口:** 55003 (HTTP/WebSocket)

Gateway 是主要入口点：
- **Web UI**: 基于浏览器的聊天界面
- **REST API**: `/v1/chat/completions` (OpenAI 兼容)
- **WebSocket**: 实时聊天流式传输
- **Channels**: 多平台消息集成

### 2. Agent
**连接:** Unix Socket (`/tmp/ocg-agent.sock`)

Agent 处理核心逻辑：
- **Pulse**: 事件循环和心跳系统
- **Context**: 消息历史和令牌管理
- **Tools**: 17+ 内置工具 (文件 I/O、执行、浏览器等)
- **Tasks**: 任务调度和拆分
- **Memory**: 带 HNSW/FAISS 的向量记忆

### 3. Embedding
**端口:** 50000-60000 (HTTP)

Embedding 服务提供：
- **文本 Embedding**: 生成向量用于语义搜索
- **向量搜索**: 查找相似记忆
- **本地模型**: 使用 llama.cpp 进行离线 embedding

---

## 数据流程

### 聊天请求
```
用户 → Gateway (55003) → Agent (Socket) → LLM → 响应 → 用户
          │                              │
          ├── 向量搜索 ─────────────────┤
          └── 记忆召回 ─────────────────┘
```

### 记忆存储
```
用户消息 → Embedding 服务 → 向量索引
                               → SQLite (全文)
```

---

## 进程模型

OCG 使用多进程架构以实现：
- **隔离**: 一个服务的崩溃不影响其他服务
- **可扩展性**: 服务可以独立扩展
- **简单性**: 单二进制，无复杂依赖

**启动顺序:**
1. Embedding (等待 llama.cpp)
2. Agent (等待 embedding 健康检查)
3. Gateway (等待 agent socket)

---

## 相关文档

- [进程模型](processes-zh.md)
- [通信机制](communication-zh.md)
- [端口配置](03-configuration/ports-zh.md)
